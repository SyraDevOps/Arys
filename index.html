<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title></title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background: transparent;
            overflow: hidden; /* Previne scroll indesejado */
        }

        /* Atualizar estilos da barra superior */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: #1e1e1e;
            border-bottom: 1px solid #3c3c3c;
            display: flex;
            justify-content: space-between;
            align-items: center;
            -webkit-app-region: drag;
            z-index: 1000;
        }

        .window-info {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
            color: #d4d4d4;
            font-size: 12px;
            -webkit-app-region: drag;
        }

        .path-separator {
            color: #666;
        }

        #current-folder {
            color: #999;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .window-controls {
            display: flex;
            gap: 0;
            height: 100%;
            -webkit-app-region: no-drag;
        }

        .control-button {
            width: 46px;
            height: 100%;
            border: none;
            background: transparent;
            color: #d4d4d4;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-button:hover {
            background: #3c3c3c;
        }

        #close-btn:hover {
            background: #e81123;
            color: white;
        }

        .container {
            display: flex;
            width: 100vw;
            height: 100vh;
            padding: 0; /* Removido padding */
            box-sizing: border-box;
            position: relative; /* Para posicionamento absoluto dos botões */
            margin-top: 40px; /* Adicionar margem para a barra superior */
        }

        .editor-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-left: 40px; /* Default margin for side menu */
            transition: margin-left 0.3s ease;
            width: calc(100% - 40px); /* Largura total menos o menu lateral */
        }

        .editor-section.with-explorer {
            margin-left: 290px; /* side menu (40px) + explorer width (250px) */
            width: calc(100% - 290px); /* Largura total menos menu lateral e explorer */
        }

        .editor-container {
            display: flex;
            background: #1e1e1e;
            height: 100%;
            width: 100%;
            min-width: 0; /* Importante para evitar overflow */
        }

        .line-numbers {
            padding: 15px 10px;
            background: #252526;
            color: #858585;
            font-family: 'Consolas', monospace;
            text-align: right;
            user-select: none;
        }

        #text-editor {
            flex: 1;
            padding: 15px;
            border: none;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
            width: 100%;
            min-width: 0; /* Importante para evitar overflow */
        }

        /* Novo estilo para a barra lateral */
        .side-menu {
            position: fixed;
            left: 0;
            top: 30px; /* Altura da top-bar */
            bottom: 0;
            width: 40px;
            background: #252526;
            border-right: 1px solid #3c3c3c;
            z-index: 998;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 10px;
        }

        .explorer-toggle {
            width: 100%;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: #7b68ee;
        }

        .explorer-toggle:hover {
            background: #2a2d2e;
        }

        .side-menu-item {
            width: 100%;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: #d4d4d4;
        }

        .side-menu-item:hover {
            background: #2a2d2e;
        }

        /* Atualizar a posição do file-explorer */
        .file-explorer {
            position: fixed;
            left: 40px; /* Side menu width */
            top: 30px;
            bottom: 0;
            width: 250px;
            background: #252526;
            color: #d4d4d4;
            font-size: 13px;
            border-right: 1px solid #3c3c3c;
            display: none;
            z-index: 99;
        }

        .file-explorer.visible {
            display: block;
        }

        /* Remover a toolbar antiga */
        .toolbar {
            display: none;
        }

        /* Ajustar posição da personagem */
        .character-section {
            position: fixed;
            top: 50px; /* Ajustado para ficar abaixo da barra superior */
            right: 20px;
            z-index: 100;
            display: flex;
            justify-content: flex-end;
        }

        #character-img {
            width: 150px;
            height: 200px;
            object-fit: contain;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 30px);
            margin-top: 30px;
            position: relative;
            width: 100%;
        }

        /* Estilo para o cabeçalho do explorador de arquivos */
        .file-explorer-header {
            padding: 8px;
            background: #252526;
            display: flex;
            align-items: center;
            gap: 5px;
            border-bottom: 1px solid #3c3c3c;
        }

        .file-explorer-title {
            flex: 1;
            font-size: 12px;
            color: #969696;
        }

        .file-explorer-controls {
            display: flex;
            gap: 5px;
        }

        .path-navigation {
            padding: 5px 8px;
            background: #2d2d2d;
            font-size: 12px;
            color: #d4d4d4;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .nav-button {
            padding: 3px 8px;
            background: none;
            border: none;
            color: #d4d4d4;
            cursor: pointer;
            font-size: 14px;
        }

        .nav-button:hover {
            background: #383838;
        }

        /* Adicionar estilos para a árvore de arquivos com submenus */
        .file-tree {
            padding: 5px;
        }

        .file-item {
            padding: 3px 5px 3px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .file-item:hover {
            background: #2a2d2e;
        }

        .file-item.expanded > .submenu {
            display: block;
        }

        .submenu {
            display: none;
            margin-left: 20px;
            padding-left: 10px;
            border-left: 1px solid #3c3c3c;
            margin-top: 3px;
        }

        .folder-content {
            margin-left: 20px;
        }

        .folder > .folder-name {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .folder > .folder-name::before {
            content: '▶';
            font-size: 10px;
            transition: transform 0.2s;
        }

        .folder.expanded > .folder-name::before {
            transform: rotate(90deg);
        }

        /* Ajustar posição específica para a imagem Python */
        #character-img.python-state {
            margin-right: 25px;
        }

        .submenu-container {
            position: fixed;
            left: 40px; /* Largura do side-menu */
            top: 30px;
            background: #252526;
            border: 1px solid #3c3c3c;
            display: none;
            z-index: 1000;
        }

        .submenu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            cursor: pointer;
            color: #d4d4d4;
            width: 200px;
        }

        .submenu-item:hover {
            background: #2a2d2e;
        }

        .submenu-text {
            font-size: 12px;
        }

        .show-submenu {
            display: block;
        }

        /* Estilos para os ícones de pasta */
        .folder > .folder-name .file-icon,
        .file-explorer-controls .nav-button,
        #file-menu .menu-icon {
            color: #7b68ee; /* Violeta */
        }

        .file > .file-name .file-icon {
            color: #d4d4d4; /* Branco para arquivos normais */
        }

        /* Estilos para o menu de contexto */
        .context-menu {
            position: fixed;
            background: #2d2d2d;
            border: 1px solid #3c3c3c;
            padding: 5px 0;
            min-width: 150px;
            z-index: 1000;
        }

        .context-menu-item {
            padding: 5px 15px;
            cursor: pointer;
            color: #d4d4d4;
            font-size: 12px;
        }

        .context-menu-item:hover {
            background: #3c3c3c;
        }

        /* Janela interna flutuante */
        #window-manager {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 200;
        }
        .internal-window {
            position: absolute;
            top: 60px;
            left: 60px;
            width: 600px;
            height: 400px;
            background: #232336;
            border: 1px solid #3c3c3c;
            border-radius: 8px;
            box-shadow: 0 4px 24px #0006;
            overflow: hidden;
            pointer-events: auto;
            min-width: 320px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            transition: height 0.2s ease;
        }
        .window-bar {
            background: #1e1e1e;
            color: #7b68ee;
            padding: 6px 12px;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 15px;
            user-select: none;
        }
        .window-close {
            background: none;
            border: none;
            color: #d4d4d4;
            font-size: 18px;
            cursor: pointer;
        }
        .window-close:hover {
            color: #ff6b6b;
        }
        .window-content {
            flex: 1;
            border: none;
            width: 100%;
            height: 100%;
            background: transparent;
        }

        .window-btn {
            padding: 4px 8px;
            background: none;
            border: none;
            color: #d4d4d4;
            cursor: pointer;
            border-radius: 3px;
        }
        .window-btn:hover {
            background: #3c3c3c;
        }
        .window-btn[data-action="close"]:hover {
            background: #e81123;
            color: white;
        }
        .internal-window.maximized {
            border-radius: 0;
        }

        .window-header {
            cursor: move;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 8px;
        }

        .window-controls {
            display: flex;
            gap: 4px;
        }

        .window-btn {
            padding: 4px 8px;
            background: none;
            border: none;
            color: #d4d4d4;
            cursor: pointer;
            border-radius: 3px;
        }

        .window-btn:hover {
            background: #3c3c3c;
        }

        .window-btn[data-action="close"]:hover {
            background: #e81123;
            color: white;
        }

        .internal-window.dragging {
            opacity: 0.8;
            cursor: move;
        }

        #md-preview-btn {
    position: absolute;
    bottom: 28px;
    right: 38px;
    z-index: 300;
    font-size: 22px;
    background: #181818;
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    box-shadow: 0 2px 8px #0004;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    display: none;
}
#md-preview-btn:hover {
    background: #fff;
    color: #181818;
    box-shadow: 0 4px 16px #0006;
}
#md-preview-btn svg polygon {
    transition: fill 0.2s;
}
#md-preview-btn:hover svg polygon {
    fill: #181818;
}

/* Novos estilos para janelas internas de PDF */
.internal-window[data-type="pdf"] .window-content {
    background: #fff;
}

.internal-window[data-type="pdf"] {
    min-width: 600px;
    min-height: 400px;
}

/* Estilos para preview de Markdown */
.internal-window[data-type="md"] {
    min-width: 600px;
    min-height: 400px;
}

.internal-window[data-type="md"] .window-content {
    background: #1e1e1e;
}
    </style>
</head>
<body>
    <!-- Atualizar a estrutura da barra superior -->
    <div class="top-bar">
        <div class="window-info">
            <span class="window-title">Arys</span>
            <span class="path-separator">-</span>
            <span id="current-folder">Sem pasta</span>
            <span class="path-separator">-</span>
            <span id="current-title">Sem título</span>
        </div>
        <div class="window-controls">
            <button class="control-button" id="minimize-btn" title="Minimizar">─</button>
            <button class="control-button" id="maximize-btn" title="Maximizar">□</button>
            <button class="control-button" id="close-btn" title="Fechar">×</button>
        </div>
    </div>

    <div class="container">
        <!-- Substituir a menu-bar existente -->
        <div class="side-menu">
            <!-- Adicionar este botão no topo do side-menu -->
            <div class="explorer-toggle" id="show-explorer" title="Mostrar Explorador">
                <span class="file-icon">📂</span>
            </div>
            <div class="side-menu-item" id="file-menu" title="Arquivo">
                <span class="menu-icon">📁</span>
            </div>
        </div>

        <!-- Adicionar o submenu -->
        <div class="submenu-container" id="file-submenu">
            <div class="submenu-item" id="new-file">
                <span class="file-icon">📄</span>
                <span class="submenu-text">Novo Arquivo</span>
            </div>
            <div class="submenu-item" id="open-file">
                <span class="file-icon">📂</span>
                <span class="submenu-text">Abrir Arquivo</span>
            </div>
            <div class="submenu-item" id="open-folder">
                <span class="file-icon">📁</span>
                <span class="submenu-text">Abrir Pasta</span>
            </div>
            <div class="submenu-item" id="save-file">
                <span class="file-icon">💾</span>
                <span class="submenu-text">Salvar</span>
            </div>
            <div class="submenu-item" id="save-as">
                <span class="file-icon">💾</span>
                <span class="submenu-text">Salvar Como</span>
            </div>
            <div class="submenu-item" id="new-window">
                <span class="file-icon">🏠</span>
                <span class="submenu-text">Nova Janela</span>
            </div>
        </div>

        <div class="main-container">
            <!-- Atualizar a estrutura do file-explorer -->
            <div class="file-explorer">
                <div class="file-explorer-header">
                    <button class="nav-button" id="toggle-explorer">◀</button>
                    <div class="file-explorer-title">EXPLORADOR</div>
                    <div class="file-explorer-controls">
                        <button class="nav-button" id="open-folder" title="Abrir pasta">📁</button>
                    </div>
                </div>
                <div class="path-navigation">
                    <button class="nav-button" id="nav-back" title="Voltar">◀</button>
                    <span id="current-path">...</span>
                </div>
                <div class="file-tree"></div>
            </div>

            <!-- Editor section -->
            <div class="editor-section">
                <div class="editor-container">
                    <!-- Adicionar iframe para welcome page -->
                    <iframe id="welcome-frame" src="welcome.html" style="display: none; width: 100%; height: 100%; border: none;"></iframe>
                    
                    <div class="line-numbers"></div>
                    <textarea id="text-editor" spellcheck="false"></textarea>
                    <button id="md-preview-btn" title="Visualizar Markdown"
  style="display:none;position:absolute;bottom:28px;right:38px;z-index:300;
         font-size:22px;background:#181818;color:#fff;border:none;
         border-radius:50%;width:44px;height:44px;box-shadow:0 2px 8px #0004;
         cursor:pointer;transition:background 0.2s,transform 0.1s;">
    <span style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;">
        <svg width="26" height="26" viewBox="0 0 26 26" fill="none">
            <circle cx="13" cy="13" r="13" fill="#181818"/>
            <polygon points="10,8 20,13 10,18" fill="#fff"/>
        </svg>
    </span>
</button>
                    <!-- Adicione aqui -->
                    <div id="window-manager"></div>
                </div>
            </div>
        </div>

        <div class="character-section">
            <img id="character-img" src="imgs/padrão.png" alt="Mascote">
        </div>
    </div>

    <input type="file" id="file-input" style="display: none;">
    
    <script>
        const { ipcRenderer } = require('electron');
        const fs = require('fs');
        const path = require('path');
        const { marked } = require('marked');
        
        const textEditor = document.getElementById('text-editor');
        const characterImg = document.getElementById('character-img');
        const lineNumbers = document.querySelector('.line-numbers');
        const fileInput = document.getElementById('file-input');
        const currentFile = document.getElementById('current-file');
        const welcomeFrame = document.getElementById('welcome-frame');
        const mdPreviewBtn = document.getElementById('md-preview-btn');
        
        let currentFilePath = null;
        let trocada = false;
        let revertTimeout = null;

        // Função para atualizar números de linha
        function updateLineNumbers() {
            const lines = textEditor.value.split('\n').length;
            lineNumbers.innerHTML = Array(lines)
                .fill(0)
                .map((_, i) => `<div>${i + 1}</div>`)
                .join('');
        }

        // Função para alternar entre editor e welcome page
        function toggleWelcomePage(showWelcome) {
            welcomeFrame.style.display = showWelcome ? 'block' : 'none';
            textEditor.style.display = showWelcome ? 'none' : 'block';
            lineNumbers.style.display = showWelcome ? 'none' : 'block';
        }

        // Mostrar welcome page inicialmente
        toggleWelcomePage(true);

        // Ouvir mensagens do iframe
        window.addEventListener('message', (event) => {
            if (event.data.command === 'new-file') {
                document.getElementById('new-file').click();
                toggleWelcomePage(false);
            } else if (event.data.command === 'open-folder') {
                document.getElementById('open-folder').click();
                toggleWelcomePage(false);
            } else if (event.data.command === 'show-camera-form') {
                createInternalWindow({ title: 'Abrir Câmera', src: 'camera-form.html', icon: "📷" });
            } else if (event.data.command === 'open-camera') {
                const iframe = createInternalWindow({ title: 'Câmera', src: 'camera-view.html', icon: "📷" });
                iframe.onload = () => {
                    iframe.contentWindow.postMessage({ cameraUrl: event.data.url }, '*');
                };
            } else if (event.data.command === 'close-window') {
                const win = document.querySelector(`.internal-window[data-window-id="${event.data.windowId}"]`);
                if (win) win.remove();
            }
        });

        // Eventos do editor
        textEditor.addEventListener('input', () => {
            updateLineNumbers();
            if (!trocada) {
                characterImg.src = currentCharacterState === 'python' ? 
                    'imgs/python.png' : 'imgs/lendo.png';
                trocada = true;
            }
            if (revertTimeout) clearTimeout(revertTimeout);
            revertTimeout = setTimeout(() => {
                characterImg.src = `imgs/${currentCharacterState}.png`;
                trocada = false;
            }, 4000);
        });

        textEditor.addEventListener('scroll', () => {
            lineNumbers.scrollTop = textEditor.scrollTop;
        });

        // Funções de arquivo
        document.getElementById('new-file').onclick = () => {
            if (confirm('Deseja criar um novo arquivo? Alterações não salvas serão perdidas.')) {
                textEditor.value = '';
                currentFilePath = null;
                document.getElementById('current-title').textContent = 'Sem título';
                document.getElementById('current-folder').textContent = 'Sem pasta';
                updateLineNumbers();
                toggleWelcomePage(false);
            }
            mdPreviewBtn.style.display = 'none';
        };

        document.getElementById('open-file').onclick = () => {
            fileInput.click();
        };

        // Update the openFile function
        async function openFile(filePath) {
            try {
                const fileExtension = path.extname(filePath).toLowerCase();
                
                // Se for PDF, abrir em uma janela interna
                if (fileExtension === '.pdf') {
                    createInternalWindow({
                        title: path.basename(filePath),
                        src: `file://${filePath}`,
                        icon: "📄",
                        width: '80vw',
                        height: '80vh'
                    });
                    return;
                }

                const content = await fs.promises.readFile(filePath, 'utf-8');
                textEditor.value = content;
                currentFilePath = filePath;

                // Update character image based on file type
                currentCharacterState = fileExtension === '.py' ? 'python' : 'padrão';
                characterImg.src = `imgs/${currentCharacterState}.png`;
                characterImg.classList.toggle('python-state', currentCharacterState === 'python');

                // Update file information
                const fileName = path.basename(filePath);
                const folderPath = path.dirname(filePath);
                document.getElementById('current-title').textContent = fileName;
                document.getElementById('current-folder').textContent = folderPath;

                // Focus no editor e atualizar números de linha
                textEditor.focus();
                updateLineNumbers();

                // Garantir que o editor esteja visível e posicionado corretamente
                const editorSection = document.querySelector('.editor-section');
                editorSection.style.display = 'flex';
                editorSection.style.visibility = 'visible';

                // Rolar para o topo do arquivo
                textEditor.scrollTop = 0;
                lineNumbers.scrollTop = 0;

                // Se for arquivo Markdown, criar preview
                if (fileExtension === '.md') {
                    createMarkdownPreview();
                }

                // Mostrar botão de preview só para .md
                if (fileExtension === '.md') {
                    mdPreviewBtn.style.display = 'block';
                } else {
                    mdPreviewBtn.style.display = 'none';
                }

                toggleWelcomePage(false);
            } catch (err) {
                alert('Erro ao abrir arquivo: ' + err.message);
            }
        }

        // Função para criar visualização de Markdown
        function createMarkdownPreview() {
            // Evita múltiplos previews abertos
            if (document.querySelector('.internal-window[data-md-preview="true"]')) return;

            const mdContent = textEditor.value;
            const previewWindow = createInternalWindow({
                title: 'Preview Markdown',
                src: 'markdown-preview.html',
                icon: "📝",
                width: '80vw',  // Mesmo tamanho do PDF
                height: '80vh'  // Mesmo tamanho do PDF
            });
            previewWindow.parentElement.setAttribute('data-md-preview', 'true');
    previewWindow.parentElement.setAttribute('data-type', 'md'); // Adiciona tipo para estilização

            previewWindow.addEventListener('load', () => {
                previewWindow.contentWindow.postMessage({
                    command: 'update-preview',
                    content: marked.parse(mdContent)
                }, '*');
            });

            // Atualiza preview quando o editor muda
            const updatePreview = () => {
                if (previewWindow) {
                    previewWindow.contentWindow.postMessage({
                        command: 'update-preview',
                        content: marked.parse(textEditor.value)
                    }, '*');
                }
            };
            textEditor.addEventListener('input', updatePreview);

            // Remove listener ao fechar a janela
            previewWindow.parentElement.querySelector('[data-action="close"]').addEventListener('click', () => {
                textEditor.removeEventListener('input', updatePreview);
            });
        }

        // Update the file input change event
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    await openFile(file.path);
                } catch (err) {
                    alert('Erro ao abrir arquivo: ' + err.message);
                }
            }
        });

        // Adicionar save as functionality
        document.getElementById('save-as').onclick = () => {
            ipcRenderer.send('save-dialog');
        };

        // Update save functionality
        document.getElementById('save-file').onclick = () => {
            if (currentFilePath) {
                try {
                    fs.writeFileSync(currentFilePath, textEditor.value);
                    alert('Arquivo salvo!');
                } catch (err) {
                    alert('Erro ao salvar arquivo: ' + err.message);
                }
            } else {
                ipcRenderer.send('save-dialog');
            }
        };

        // IPC events
        ipcRenderer.on('save-file', (_, filePath) => {
            if (filePath) {
                fs.writeFileSync(filePath, textEditor.value);
                currentFilePath = filePath;
                currentFile.textContent = path.basename(filePath);
                alert('Arquivo salvo!');
            }
        });

        // Variáveis para controle do mouse
        let mouseTimeout = null;
        let lastMousePosition = { x: 0, y: 0 };

        // Evento de movimento do mouse
        document.addEventListener('mousemove', (e) => {
            if (!trocada) {
                const deltaX = Math.abs(e.clientX - lastMousePosition.x);
                const deltaY = Math.abs(e.clientY - lastMousePosition.y);
                
                if (deltaX > 5 || deltaY > 5) {
                    characterImg.src = currentCharacterState === 'python' ? 
                        'imgs/python.png' : 'imgs/vendo.png';
                    trocada = true;
                }
            }

            lastMousePosition.x = e.clientX;
            lastMousePosition.y = e.clientY;

            if (mouseTimeout) clearTimeout(mouseTimeout);
            mouseTimeout = setTimeout(() => {
                characterImg.src = `imgs/${currentCharacterState}.png`;
                trocada = false;
            }, 2000);
        });

        // Botão de fechar
        document.getElementById('close-btn').addEventListener('click', () => {
            ipcRenderer.send('close-window');
        });

        // Adicionar controle de maximização
        const maximizeBtn = document.getElementById('maximize-btn');
        let isMaximized = true;

        maximizeBtn.addEventListener('click', () => {
            ipcRenderer.send('toggle-maximize');
            isMaximized = !isMaximized;
            maximizeBtn.innerHTML = isMaximized ? '□' : '▢';
        });

        // Atualizar o ícone do botão quando a janela mudar de estado
        ipcRenderer.on('window-state-change', (_, maximized) => {
            isMaximized = maximized;
            maximizeBtn.innerHTML = isMaximized ? '□' : '▢';
        });

        // Função para criar elemento da árvore de arquivos
        function createFileTreeItem(item, isFolder) {
            const itemDiv = document.createElement('div');
            itemDiv.className = `file-item ${isFolder ? 'folder' : 'file'}`;
            
            const nameDiv = document.createElement('div');
            nameDiv.className = isFolder ? 'folder-name' : 'file-name';
            
            const icon = document.createElement('span');
            icon.className = 'file-icon';
            icon.innerHTML = isFolder ? '📁' : '📄';
            icon.style.color = isFolder ? '#7b68ee' : '#d4d4d4';
            
            const text = document.createElement('span');
            text.textContent = item.name;
            
            nameDiv.appendChild(icon);
            nameDiv.appendChild(text);
            itemDiv.appendChild(nameDiv);
            
            if (isFolder) {
                // Adicionar menu de contexto para pastas
                itemDiv.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    const contextMenu = createContextMenu([
                        { label: 'Nova Pasta', action: () => createNewFolder(item.path) },
                        { label: 'Novo Arquivo', action: () => createNewFile(item.path) },
                        { label: 'Renomear', action: () => renameItem(item.path) },
                        { label: 'Excluir', action: () => deleteItem(item.path) }
                    ]);
                    showContextMenu(e, contextMenu);
                });

                const submenu = document.createElement('div');
                submenu.className = 'submenu';
                itemDiv.appendChild(submenu);
                
                nameDiv.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    itemDiv.classList.toggle('expanded');
                    
                    if (!submenu.hasChildNodes()) {
                        try {
                            const subItems = await fs.promises.readdir(item.path, { withFileTypes: true });
                            const sortedSubItems = subItems
                                .map(subItem => ({
                                    name: subItem.name,
                                    isDirectory: subItem.isDirectory(),
                                    path: path.join(item.path, subItem.name)
                                }))
                                .sort((a, b) => {
                                    if (a.isDirectory === b.isDirectory) {
                                        return a.name.localeCompare(b.name);
                                    }
                                    return a.isDirectory ? -1 : 1;
                                });

                            sortedSubItems.forEach(subItem => {
                                const subElement = createFileTreeItem(subItem, subItem.isDirectory);
                                submenu.appendChild(subElement);
                            });
                        } catch (err) {
                            console.error('Error loading subfolder:', err);
                        }
                    }
                });
            } else {
                // Adicionar menu de contexto para arquivos
                itemDiv.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    const contextMenu = createContextMenu([
                        { label: 'Renomear', action: () => renameItem(item.path) },
                        { label: 'Excluir', action: () => deleteItem(item.path) }
                    ]);
                    showContextMenu(e, contextMenu);
                });

                itemDiv.addEventListener('click', () => openFile(item.path));
            }

            return itemDiv;
        }

        // Funções auxiliares para o menu de contexto
        function createContextMenu(items) {
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            items.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.className = 'context-menu-item';
                menuItem.textContent = item.label;
                menuItem.onclick = item.action;
                menu.appendChild(menuItem);
            });
            return menu;
        }

        function showContextMenu(event, menu) {
            // Remover menus anteriores
            document.querySelectorAll('.context-menu').forEach(m => m.remove());
            
            // Posicionar e mostrar o novo menu
            document.body.appendChild(menu);
            menu.style.left = `${event.clientX}px`;
            menu.style.top = `${event.clientY}px`;
            
            // Fechar ao clicar fora
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 0);
        }

        // Função para renderizar árvore de arquivos
        function renderFileTree(parentElement, items) {
            parentElement.innerHTML = '';
            items.forEach(item => {
                const element = createFileTreeItem(item, item.isDirectory);
                parentElement.appendChild(element);
            });
            
            // Don't modify visibility here, let the toggle button handle it
            const explorer = document.querySelector('.file-explorer');
            const editorSection = document.querySelector('.editor-section');
            editorSection.classList.toggle('with-explorer', explorer.classList.contains('visible'));
        }

        // Adicionar ao script existente
        let navigationHistory = [];
        let currentDirPath = null;

        // Atualizar a função loadDirectory
        async function loadDirectory(dirPath, addToHistory = true) {
            try {
                const items = await fs.promises.readdir(dirPath, { withFileTypes: true });
                const fileTree = document.querySelector('.file-tree');
                
                if (addToHistory && currentDirPath) {
                    navigationHistory.push(currentDirPath);
                }
                currentDirPath = dirPath;
                
                // Atualizar o caminho da pasta na barra superior
                document.getElementById('current-folder').textContent = dirPath;
                document.getElementById('current-path').textContent = dirPath;
                
                const sortedItems = items
                    .map(item => ({
                        name: item.name,
                        isDirectory: item.isDirectory(),
                        path: path.join(dirPath, item.name)
                    }))
                    .sort((a, b) => {
                        if (a.isDirectory === b.isDirectory) {
                            return a.name.localeCompare(b.name);
                        }
                        return a.isDirectory ? -1 : 1;
                    });

                renderFileTree(fileTree, sortedItems);
                document.querySelector('.file-explorer').classList.add('visible');
            } catch (err) {
                alert('Erro ao carregar diretório: ' + err.message);
            }
        }

        // Adicionar navegação para trás
        document.getElementById('nav-back').addEventListener('click', () => {
            if (navigationHistory.length > 0) {
                const previousPath = navigationHistory.pop();
                loadDirectory(previousPath, false);
            }
        });

        // Atualizar o toggle do explorer
        document.getElementById('toggle-explorer').onclick = () => {
            const explorer = document.querySelector('.file-explorer');
            const editorSection = document.querySelector('.editor-section');
            const button = document.getElementById('toggle-explorer');
            const isVisible = explorer.classList.toggle('visible');
            
            editorSection.classList.toggle('with-explorer', isVisible);
            button.textContent = isVisible ? '◀' : '▶';
            
            // Manter o foco no editor
            textEditor.focus();
        };

        // Open folder
        document.getElementById('open-folder').onclick = async () => {
            const result = await ipcRenderer.invoke('select-folder');
            if (result.filePaths[0]) {
                navigationHistory = []; // Limpar histórico ao abrir nova pasta
                loadDirectory(result.filePaths[0]);
                document.querySelector('.file-explorer').classList.add('visible');
            }
        };

        // Atualizar a função que gerencia o estado do personagem
        async function openFile(filePath) {
            try {
                const content = await fs.promises.readFile(filePath, 'utf-8');
                textEditor.value = content;
                currentFilePath = filePath;
                
                // Update character image based on file type
                const fileExtension = path.extname(filePath).toLowerCase();
                currentCharacterState = fileExtension === '.py' ? 'python' : 'padrão';
                characterImg.src = `imgs/${currentCharacterState}.png`;
                characterImg.classList.toggle('python-state', currentCharacterState === 'python');

                // Update file information
                const fileName = path.basename(filePath);
                const folderPath = path.dirname(filePath);
                document.getElementById('current-title').textContent = fileName;
                document.getElementById('current-folder').textContent = folderPath;

                // Focus no editor e atualizar números de linha
                textEditor.focus();
                updateLineNumbers();

                // Garantir que o editor esteja visível e posicionado corretamente
                const editorSection = document.querySelector('.editor-section');
                editorSection.style.display = 'flex';
                editorSection.style.visibility = 'visible';
                
                // Rolar para o topo do arquivo
                textEditor.scrollTop = 0;
                lineNumbers.scrollTop = 0;

                // Mostrar botão de preview só para .md
                if (fileExtension === '.md') {
                    mdPreviewBtn.style.display = 'block';
                } else {
                    mdPreviewBtn.style.display = 'none';
                }

                toggleWelcomePage(false);
            } catch (err) {
                alert('Erro ao abrir arquivo: ' + err.message);
            }
        }

        // Inicialização
        updateLineNumbers();

        // Update the event listeners to maintain the Python image during interactions
        let currentCharacterState = "padrão";

        textEditor.addEventListener('input', () => {
            updateLineNumbers();
            if (!trocada) {
                characterImg.src = currentCharacterState === 'python' ? 
                    'imgs/python.png' : 'imgs/lendo.png';
                trocada = true;
            }
            if (revertTimeout) clearTimeout(revertTimeout);
            revertTimeout = setTimeout(() => {
                characterImg.src = `imgs/${currentCharacterState}.png`;
                trocada = false;
            }, 4000);
        });

        document.addEventListener('mousemove', (e) => {
            if (!trocada) {
                const deltaX = Math.abs(e.clientX - lastMousePosition.x);
                const deltaY = Math.abs(e.clientY - lastMousePosition.y);
                
                if (deltaX > 5 || deltaY > 5) {
                    characterImg.src = currentCharacterState === 'python' ? 
                        'imgs/python.png' : 'imgs/vendo.png';
                    trocada = true;
                }
            }

            lastMousePosition.x = e.clientX;
            lastMousePosition.y = e.clientY;

            if (mouseTimeout) clearTimeout(mouseTimeout);
            mouseTimeout = setTimeout(() => {
                characterImg.src = `imgs/${currentCharacterState}.png`;
                trocada = false;
            }, 2000);
        });

        // Adicionar ao seu script existente
        document.getElementById('minimize-btn').addEventListener('click', () => {
            ipcRenderer.send('minimize-window');
        });

        // Controle do submenu
        const fileMenu = document.getElementById('file-menu');
        const fileSubmenu = document.getElementById('file-submenu');
        
        fileMenu.addEventListener('click', (e) => {
            e.stopPropagation();
            fileSubmenu.classList.toggle('show-submenu');
        });

        // Fechar submenu ao clicar fora
        document.addEventListener('click', (e) => {
            if (!fileSubmenu.contains(e.target) && !fileMenu.contains(e.target)) {
                fileSubmenu.classList.remove('show-submenu');
            }
        });

        // Atualizar os event listeners existentes para usar os novos IDs
        document.getElementById('new-file').addEventListener('click', () => {
            if (confirm('Deseja criar um novo arquivo? Alterações não salvas serão perdidas.')) {
                textEditor.value = '';
                currentFilePath = null;
                document.getElementById('current-title').textContent = 'Sem título';
                document.getElementById('current-folder').textContent = 'Sem pasta';
                updateLineNumbers();
                toggleWelcomePage(false);
            }
            mdPreviewBtn.style.display = 'none';
            fileSubmenu.classList.remove('show-submenu');
        });

        document.getElementById('open-file').addEventListener('click', () => {
            fileInput.click();
            fileSubmenu.classList.remove('show-submenu');
        });

        document.getElementById('new-window').addEventListener('click', () => {
    toggleWelcomePage(true);  // Isso vai mostrar o welcome
    fileSubmenu.classList.remove('show-submenu');
});
        // Update the openFile function
        async function openFile(filePath) {
            try {
                const fileExtension = path.extname(filePath).toLowerCase();
                
                // Se for PDF, abrir em uma janela interna
                if (fileExtension === '.pdf') {
                    createInternalWindow({
                        title: path.basename(filePath),
                        src: `file://${filePath}`,
                        icon: "📄",
                        width: '80vw',
                        height: '80vh'
                    });
                    return;
                }

                const content = await fs.promises.readFile(filePath, 'utf-8');
                textEditor.value = content;
                currentFilePath = filePath;
                
                // Update character image
                currentCharacterState = fileExtension === '.py' ? 'python' : 'padrão';
                characterImg.src = `imgs/${currentCharacterState}.png`;
                characterImg.classList.toggle('python-state', currentCharacterState === 'python');

                // Update file information
                const fileName = path.basename(filePath);
                const folderPath = path.dirname(filePath);
                document.getElementById('current-title').textContent = fileName;
                document.getElementById('current-folder').textContent = folderPath;

                // Focus no editor e atualizar números de linha
                textEditor.focus();
                updateLineNumbers();

                // Garantir que o editor esteja visível e posicionado corretamente
                const editorSection = document.querySelector('.editor-section');
                editorSection.style.display = 'flex';
                editorSection.style.visibility = 'visible';
                
                // Rolar para o topo do arquivo
                textEditor.scrollTop = 0;
                lineNumbers.scrollTop = 0;

                // Mostrar botão de preview só para .md
                mdPreviewBtn.style.display = fileExtension === '.md' ? 'block' : 'none';
                if (fileExtension === '.md') {
                    mdPreviewBtn.style.display = 'block';
                } else {
                    mdPreviewBtn.style.display = 'none';
                }

                toggleWelcomePage(false);
            } catch (err) {
                alert('Erro ao abrir arquivo: ' + err.message);
            }
        }

        // Update save functionality
        document.getElementById('save-file').onclick = () => {
            if (currentFilePath) {
                try {
                    fs.writeFileSync(currentFilePath, textEditor.value);
                    alert('Arquivo salvo!');
                } catch (err) {
                    alert('Erro ao salvar arquivo: ' + err.message);
                }
            } else {
                ipcRenderer.send('save-dialog');
            }
        };

        // IPC events
        ipcRenderer.on('save-file', (_, filePath) => {
            if (filePath) {
                fs.writeFileSync(filePath, textEditor.value);
                currentFilePath = filePath;
                currentFile.textContent = path.basename(filePath);
                alert('Arquivo salvo!');
            }
        });

        // Atualizar o comportamento do explorador
        document.getElementById('show-explorer').addEventListener('click', () => {
            const explorer = document.querySelector('.file-explorer');
            const editorSection = document.querySelector('.editor-section');
            explorer.classList.add('visible');
            editorSection.classList.add('with-explorer');
        });

        function createInternalWindow({ title, src, icon = "🗔", width = '600px', height = '400px' }) {
    const wm = document.getElementById('window-manager');
    const win = document.createElement('div');
    win.className = 'internal-window';
    win.dataset.windowId = Date.now().toString();
    
    const bar = document.createElement('div');
    bar.className = 'window-bar';
    bar.innerHTML = `
        <div class="window-header">
            <span class="window-icon">${icon}</span>
            <span class="window-title">${title}</span>
        </div>
        <div class="window-controls">
            <button class="window-btn" data-action="minimize" title="Minimizar">─</button>
            <button class="window-btn" data-action="maximize" title="Maximizar">□</button>
            <button class="window-btn" data-action="close" title="Fechar">×</button>
        </div>
    `;

    const content = document.createElement('iframe');
    content.className = 'window-content';
    content.src = src;

    // Adicionar controles
    const controls = bar.querySelector('.window-controls');
    controls.addEventListener('click', (e) => {
        const action = e.target.dataset.action;
        if (action === 'close') {
            win.remove();
        } else if (action === 'minimize') {
            if (win.style.height === '32px') {
                win.style.height = win.dataset.prevHeight;
                content.style.display = 'block';
            } else {
                win.dataset.prevHeight = win.style.height;
                win.style.height = '32px';
                content.style.display = 'none';
            }
        } else if (action === 'maximize') {
            if (!win.classList.contains('maximized')) {
                win.dataset.prevState = JSON.stringify({
                    left: win.style.left,
                    top: win.style.top,
                    width: win.style.width,
                    height: win.style.height
                });
                win.style.left = '0';
                win.style.top = '30px';
                win.style.width = '100vw';
                win.style.height = 'calc(100vh - 30px)';
                win.classList.add('maximized');
            } else {
                const prevState = JSON.parse(win.dataset.prevState || '{}');
                Object.assign(win.style, prevState);
                win.classList.remove('maximized');
            }
        }
    });

    // Arrastar janela
    let isDragging = false;
    let startX, startY;

    bar.querySelector('.window-header').addEventListener('mousedown', (e) => {
        if (!win.classList.contains('maximized')) {
            isDragging = true;
            startX = e.clientX - win.offsetLeft;
            startY = e.clientY - win.offsetTop;
            win.style.zIndex = Date.now();
        }
    });

    document.addEventListener('mousemove', (e) => {
        if (isDragging) {
            win.style.left = `${e.clientX - startX}px`;
            win.style.top = `${e.clientY - startY}px`;
        }
    });

    document.addEventListener('mouseup', () => {
        isDragging = false;
    });

    win.appendChild(bar);
    win.appendChild(content);
    wm.appendChild(win);

    // Posição inicial
    win.style.position = 'absolute';
    win.style.left = '80px';
    win.style.top = '80px';
    win.style.width = width;
    win.style.height = height;

    return content;
}

// Adicionar evento de clique para o botão de preview de Markdown
mdPreviewBtn.addEventListener('click', () => {
    createMarkdownPreview();
});
    </script>
</body>
</html>
