<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Arys Editor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d2d;
            --border-color: #3c3c3c;
            --text-primary: #d4d4d4;
            --text-secondary: #cccccc;
            --text-muted: #858585;
            --accent-color: #7b68ee;
            --hover-bg: #3a3d41;
            --active-bg: #3c3c3c;
            --close-hover-bg: #e81123;
            --close-hover-text: white;
            --highlight-bg: rgba(123, 104, 238, 0.4);
            --highlight-active-bg: rgba(123, 104, 238, 0.7);
            --selection-bg: rgba(123, 104, 238, 0.2);
            --delete-color: #f44336;
        }

        body.theme-white {
            --bg-primary: #ffffff;
            --bg-secondary: #f3f3f3;
            --bg-tertiary: #e8e8e8;
            --border-color: #d1d1d1;
            --text-primary: #1f1f1f;
            --text-secondary: #333333;
            --text-muted: #6e6e6e;
            --accent-color: #6a5acd;
            --hover-bg: #e0e0e0;
            --active-bg: #d9d9d9;
            --highlight-bg: rgba(106, 90, 205, 0.3);
            --highlight-active-bg: rgba(106, 90, 205, 0.5);
            --selection-bg: rgba(106, 90, 205, 0.2);
        }
        
        body.theme-red {
            --bg-primary: #281919;
            --bg-secondary: #3B2424;
            --bg-tertiary: #412a2a;
            --border-color: #5C3737;
            --text-primary: #F2E3E3;
            --text-secondary: #E8D5D5;
            --text-muted: #b89393;
            --accent-color: #FF6B6B;
            --hover-bg: #523434;
            --active-bg: #5C3737;
            --highlight-bg: rgba(255, 107, 107, 0.4);
            --highlight-active-bg: rgba(255, 107, 107, 0.6);
            --selection-bg: rgba(255, 107, 107, 0.2);
        }

        * { box-sizing: border-box; }
        html, body {
            width: 100%; height: 100%; margin: 0; padding: 0; background: var(--bg-primary);
            color: var(--text-primary); overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
            user-select: none;
        }
        
        .top-bar { position: fixed; top: 0; left: 0; right: 0; height: 30px; background: var(--bg-primary); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; -webkit-app-region: drag; z-index: 1000; }
        .app-layout { display: flex; height: 100vh; padding-top: 30px; }
        .side-menu { width: 45px; background: var(--bg-secondary); border-right: 1px solid var(--border-color); z-index: 999; display: flex; flex-direction: column; align-items: center; padding-top: 10px; flex-shrink: 0; }
        .main-container { display: flex; flex-grow: 1; height: 100%; position: relative; }
        .file-explorer { width: 250px; min-width: 180px; max-width: 500px; background: var(--bg-secondary); border-right: 1px solid var(--border-color); display: none; flex-direction: column; flex-shrink: 0; position: relative; }
        .file-explorer.visible { display: flex; }
        .resizer { width: 5px; cursor: col-resize; z-index: 50; flex-shrink: 0; transition: background-color 0.2s; }
        .resizer:hover, .resizer.resizing { background: var(--accent-color); }
        .editor-section { flex: 1; display: flex; flex-direction: column; min-width: 0; }

        .window-info { display: flex; align-items: center; gap: 8px; margin-left: 10px; font-size: 13px; -webkit-app-region: no-drag; }
        #current-folder, #current-title { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #modified-indicator { font-weight: bold; color: var(--accent-color); margin-left: 4px; display: inline-block; width: 10px; }
        .window-controls { display: flex; height: 100%; -webkit-app-region: no-drag; }
        .control-button { width: 46px; height: 100%; border: none; background: transparent; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .control-button .icon { width: 14px; height: 14px; }
        .control-button:hover { background: var(--hover-bg); }
        #close-btn:hover { background: var(--close-hover-bg); color: var(--close-hover-text); }
        .icon { width: 20px; height: 20px; stroke-width: 1.5; stroke: currentColor; fill: none; }

        .side-menu-item { width: 100%; height: 45px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--text-primary); }
        .side-menu-item:hover, .side-menu-item.active { background: var(--active-bg); }
        .submenu-container { position: fixed; left: 46px; background: var(--bg-secondary); border: 1px solid var(--border-color); display: none; z-index: 1001; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); padding: 4px 0; }
        #file-submenu { top: 75px; } 
        #theme-submenu { top: 165px; } /* Posição ajustada devido ao novo ícone */
        .show-submenu { display: block; }
        .submenu-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; cursor: pointer; width: 200px; }
        .submenu-item:hover { background: var(--hover-bg); }
        .submenu-item .icon { width: 16px; height: 16px; color: var(--text-secondary); }
        .submenu-text { font-size: 13px; }

        .file-explorer-header { padding: 8px; display: flex; justify-content: space-between; align-items: center; gap: 5px; border-bottom: 1px solid var(--border-color); }
        .file-explorer-title { flex-grow: 1; font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .file-explorer-controls { display: flex; gap: 4px; }
        .nav-button { padding: 4px; background: none; border: none; color: var(--text-primary); cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .nav-button:hover { background: var(--hover-bg); }
        .nav-button .icon { width: 18px; height: 18px; }
        .path-navigation { padding: 5px 8px; background: var(--bg-tertiary); font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .file-tree { padding: 5px; overflow-y: auto; flex-grow: 1; user-select: none; }
        .file-item, .folder-header { padding: 4px 8px; cursor: pointer; display: flex; align-items: center; gap: 6px; border-radius: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-item:hover, .folder-header:hover { background: var(--hover-bg); }
        .file-item.selected, .folder-header.selected { background-color: var(--selection-bg); border: 1px solid var(--accent-color); padding: 3px 7px; }
        .file-icon-wrapper { display: flex; align-items: center; justify-content: center; width: 16px; }
        .file-icon-wrapper .icon { width: 16px; height: 16px; color: var(--text-muted); }
        .folder .file-icon-wrapper .icon { color: var(--accent-color); opacity: 0.8; }
        .folder-header .folder-arrow { font-size: 10px; transition: transform 0.15s ease-in-out; display: flex; align-items: center; justify-content: center; width: 10px; }
        .folder.expanded > .folder-header .folder-arrow { transform: rotate(90deg); }
        .folder-content { display: none; padding-left: 20px; }
        .folder.expanded > .folder-content { display: block; }
        .new-item-input-wrapper { display: flex; align-items: center; gap: 6px; padding: 4px 8px; }
        .new-item-input { flex-grow: 1; background: var(--bg-primary); border: 1px solid var(--accent-color); color: var(--text-primary); font-family: 'Inter'; border-radius: 4px; outline: none; padding: 2px 4px; }

        .editor-container { display: flex; background: var(--bg-primary); height: 100%; width: 100%; position: relative; }
        .editor-wrapper { flex: 1; position: relative; display: flex; min-width: 0; }
        #editor-backdrop { position: absolute; top: 0; left: 0; right: 0; bottom: 0; padding: 15px; overflow: hidden; pointer-events: none; white-space: pre-wrap; word-wrap: break-word; }
        #highlights, #text-editor, .line-numbers { font-family: 'Fira Code', monospace; font-size: 14px; line-height: 1.6; -webkit-font-smoothing: antialiased; font-feature-settings: "liga" 1, "calt" 1; }
        #highlights .highlight { background-color: var(--highlight-bg); border-radius: 2px; }
        #highlights .highlight.active { background-color: var(--highlight-active-bg); }
        .line-numbers { padding: 15px 10px; background: var(--bg-primary); color: var(--text-muted); text-align: right; overflow-y: hidden; }
        #text-editor { position: relative; z-index: 1; flex: 1; padding: 15px; border: none; background: transparent; color: var(--text-primary); resize: none; outline: none; width: 100%; user-select: text; }

        .search-bar { position: absolute; top: 10px; right: 20px; z-index: 10; background: var(--bg-secondary); padding: 8px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 8px; border: 1px solid var(--border-color); }
        .search-bar.hidden { display: none; }
        #search-input { background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 4px 8px; border-radius: 4px; outline: none; width: 200px; }
        #search-input:focus { border-color: var(--accent-color); }
        #search-results { font-size: 12px; color: var(--text-muted); }
        .search-btn { background: none; border: none; cursor: pointer; color: var(--text-primary); padding: 4px; display: flex; align-items: center; border-radius: 4px; }
        .search-btn:hover { background: var(--hover-bg); }
        .search-btn .icon { width: 16px; height: 16px; }

        .character-section { position: fixed; bottom: 10px; right: 10px; z-index: -1; }
        #character-img { width: 150px; height: 200px; object-fit: contain; }
    </style>
</head>
<body class="theme-dark">
    <!-- BARRA SUPERIOR -->
    <div class="top-bar">
        <div class="window-info">
            <span class="window-title">Arys</span>
            <span class="path-separator">-</span>
            <span id="current-folder">Sem pasta</span>
            <span class="path-separator">-</span>
            <span id="current-title">Sem título</span>
            <span id="modified-indicator"></span>
        </div>
        <div class="window-controls">
            <button class="control-button" id="minimize-btn" title="Minimizar"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
            <button class="control-button" id="maximize-btn" title="Maximizar"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg></button>
            <button class="control-button" id="close-btn" title="Fechar"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        </div>
    </div>
    
    <!-- LAYOUT PRINCIPAL -->
    <div class="app-layout">
        <!-- BARRA LATERAL -->
        <div class="side-menu">
            <div class="side-menu-item" id="show-explorer" title="Explorador"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg></div>
            <div class="side-menu-item" id="file-menu" title="Arquivo"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg></div>
            <div class="side-menu-item" id="terminal-toggle" title="Terminal"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg></div>
            <!-- NOVO ÍCONE DE FERRAMENTAS -->
            <div class="side-menu-item" id="tools-menu" title="Ferramentas"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg></div>
            <div class="side-menu-item" id="theme-menu" title="Temas"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></div>
        </div>

        <!-- SUBMENUS -->
        <div class="submenu-container" id="file-submenu">
             <div class="submenu-item" data-action="new-file"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg><span class="submenu-text">Novo Arquivo (Ctrl+N)</span></div>
             <div class="submenu-item" data-action="open-file"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg><span class="submenu-text">Abrir Arquivo</span></div>
             <div class="submenu-item" data-action="open-folder"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg><span class="submenu-text">Abrir Pasta</span></div>
             <div class="submenu-item" data-action="save-file"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg><span class="submenu-text">Salvar (Ctrl+S)</span></div>
             <div class="submenu-item" data-action="save-as"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg><span class="submenu-text">Salvar Como</span></div>
        </div>
        <div class="submenu-container" id="theme-submenu">
            <div class="submenu-item" data-theme="dark"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg><span class="submenu-text">Tema Escuro (Dark)</span></div>
            <div class="submenu-item" data-theme="white"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg><span class="submenu-text">Tema Claro (White)</span></div>
            <div class="submenu-item" data-theme="red"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span class="submenu-text">Tema Vermelho (Red)</span></div>
        </div>
        
        <!-- CONTAINER PRINCIPAL (EXPLORER + EDITOR) -->
        <div class="main-container">
            <div class="file-explorer">
                <div class="file-explorer-header">
                    <div class="file-explorer-title">EXPLORADOR</div>
                    <div class="file-explorer-controls">
                        <button class="nav-button" id="new-file-explorer" title="Novo Arquivo"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg></button>
                        <button class="nav-button" id="new-folder-explorer" title="Nova Pasta"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg></button>
                    </div>
                </div>
                <div class="path-navigation">
                    <button class="nav-button" id="nav-back" title="Voltar"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                    <span id="current-path">Nenhuma pasta aberta</span>
                </div>
                <div class="file-tree" tabindex="-1"></div>
            </div>
            
            <div class="resizer" id="explorer-resizer"></div>

            <div class="editor-section">
                <div class="editor-container">
                    <iframe id="welcome-frame" src="welcome.html" style="display: none; width: 100%; height: 100%; border: none;"></iframe>
                    <div class="line-numbers"></div>
                    <div class="editor-wrapper">
                        <div id="editor-backdrop"><div id="highlights"></div></div>
                        <textarea id="text-editor" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
                    </div>
                    <div id="search-bar" class="search-bar hidden">
                        <input type="text" id="search-input" placeholder="Buscar...">
                        <span id="search-results">0/0</span>
                        <button class="search-btn" id="search-prev" title="Anterior"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                        <button class="search-btn" id="search-next" title="Próximo"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></button>
                        <button class="search-btn" id="search-close" title="Fechar (Esc)"><svg class="icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="character-section"><img id="character-img" src="imgs/padrão.png" alt="Mascote"></div>
    <input type="file" id="file-input" style="display: none;">

    <script>
        const { ipcRenderer } = require('electron');
        const fs = require('fs');
        const path = require('path');
        
        // --- CONSTANTES DE ÍCONES (SVG) ---
        const FOLDER_ICON_SVG = `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>`;
        const FILE_ICON_SVG = `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>`;
        const CHEVRON_RIGHT_SVG = `<svg class="icon" style="width:12px; height:12px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`;

        // --- CACHE DE ELEMENTOS DOM ---
        const dom = {
            body: document.body,
            textEditor: document.getElementById('text-editor'),
            lineNumbers: document.querySelector('.line-numbers'),
            fileExplorer: document.querySelector('.file-explorer'),
            fileTree: document.querySelector('.file-tree'),
            resizer: document.getElementById('explorer-resizer'),
            highlights: document.getElementById('highlights'),
            editorBackdrop: document.getElementById('editor-backdrop'),
            searchBar: document.getElementById('search-bar'),
            searchInput: document.getElementById('search-input'),
            searchResults: document.getElementById('search-results'),
            welcomeFrame: document.getElementById('welcome-frame'),
            fileInput: document.getElementById('file-input'),
            currentFolderTitle: document.getElementById('current-folder'),
            currentFileTitle: document.getElementById('current-title'),
            modifiedIndicator: document.getElementById('modified-indicator'),
            currentPathDisplay: document.getElementById('current-path'),
            fileSubmenu: document.getElementById('file-submenu'),
            themeSubmenu: document.getElementById('theme-submenu'),
        };
        
        // --- ESTADO DA APLICAÇÃO ---
        let state = {
            currentFilePath: null,
            isModified: false,
            currentDirPath: null,
            navigationHistory: [],
            selectedTreeItem: null, // Guarda o elemento DOM do item selecionado na árvore
            search: {
                matches: [],
                currentIndex: -1,
            }
        };
        
        // --- FUNÇÕES DE UI E EDITOR ---
        function updateTitleBar() {
            dom.currentFileTitle.textContent = state.currentFilePath ? path.basename(state.currentFilePath) : 'Sem Título';
            dom.currentFileTitle.title = state.currentFilePath || '';
            dom.modifiedIndicator.textContent = state.isModified ? '●' : '';
        }

        function createNewFile() {
            dom.textEditor.value = '';
            state.currentFilePath = null;
            state.isModified = false;
            updateLineNumbers();
            updateTitleBar();
            toggleWelcomePage(false);
            dom.textEditor.focus();
        }

        function toggleWelcomePage(show) {
            dom.welcomeFrame.style.display = show ? 'block' : 'none';
            const editorVisible = !show;
            document.querySelector('.editor-wrapper').style.display = editorVisible ? 'flex' : 'none';
            dom.lineNumbers.style.display = editorVisible ? 'block' : 'none';
            if (editorVisible) dom.textEditor.focus();
        }

        function updateLineNumbers() {
            const lineCount = dom.textEditor.value.split('\n').length || 1;
            dom.lineNumbers.innerHTML = Array.from({ length: lineCount }, (_, i) => `<div>${i + 1}</div>`).join('');
            syncScroll();
        }

        function syncScroll() {
            dom.lineNumbers.scrollTop = dom.textEditor.scrollTop;
            dom.editorBackdrop.scrollTop = dom.textEditor.scrollTop;
            dom.editorBackdrop.scrollLeft = dom.textEditor.scrollLeft;
        }

        // --- FUNÇÕES DE ARQUIVO (Abrir, Salvar) ---
        async function openFile(filePath) {
            try {
                const content = await fs.promises.readFile(filePath, 'utf-8');
                dom.textEditor.value = content;
                state.currentFilePath = filePath;
                state.isModified = false;
                dom.currentFolderTitle.textContent = path.basename(path.dirname(filePath));
                dom.currentFolderTitle.title = path.dirname(filePath);
                updateTitleBar();
                updateLineNumbers();
                toggleWelcomePage(false);
                dom.textEditor.scrollTop = 0;
            } catch (err) { alert('Erro ao abrir arquivo: ' + err.message); }
        }
        
        async function handleSave(isSaveAs = false) {
            let savePath = state.currentFilePath;
            
            if (isSaveAs || !savePath) {
                const result = await ipcRenderer.invoke('show-save-dialog');
                if (result.canceled || !result.filePath) {
                    return;
                }
                savePath = result.filePath;
            }

            try {
                await fs.promises.writeFile(savePath, dom.textEditor.value);
                state.isModified = false;
                if (savePath !== state.currentFilePath) {
                    state.currentFilePath = savePath;
                    dom.currentFolderTitle.textContent = path.basename(path.dirname(savePath));
                    dom.currentFolderTitle.title = path.dirname(savePath);
                }
                updateTitleBar();
                if (state.currentDirPath && path.dirname(savePath) === state.currentDirPath) {
                    loadDirectory(state.currentDirPath, false);
                }
            } catch (err) {
                alert('Erro ao salvar arquivo: ' + err.message);
            }
        }

        // --- LÓGICA DO EXPLORADOR DE ARQUIVOS ---
        async function loadDirectory(dirPath, addToHistory = true) {
            try {
                if (addToHistory && state.currentDirPath) state.navigationHistory.push(state.currentDirPath);
                state.currentDirPath = dirPath;
                dom.currentFolderTitle.textContent = path.basename(dirPath);
                dom.currentFolderTitle.title = dirPath;
                dom.currentPathDisplay.textContent = dirPath;
                
                const items = await fs.promises.readdir(dirPath, { withFileTypes: true });
                const sorted = items
                    .map(item => ({ name: item.name, isDirectory: item.isDirectory(), path: path.join(dirPath, item.name) }))
                    .sort((a, b) => (a.isDirectory === b.isDirectory) ? a.name.localeCompare(b.name) : a.isDirectory ? -1 : 1);
                
                renderFileTree(sorted);
                if (!dom.fileExplorer.classList.contains('visible')) {
                    dom.fileExplorer.classList.add('visible');
                }
            } catch (err) { console.error('Erro ao carregar diretório:', err); alert("Não foi possível carregar o diretório."); }
        }

        function renderFileTree(items) {
            dom.fileTree.innerHTML = '';
            items.forEach(item => {
                dom.fileTree.appendChild(createFileTreeItem(item));
            });
            state.selectedTreeItem = null;
        }
        
        function createFileTreeItem(item) {
            const isFolder = item.isDirectory;
            const element = document.createElement('div');
            
            element.dataset.path = item.path;
            element.dataset.type = isFolder ? 'folder' : 'file';

            const selectItem = (el) => {
                if (state.selectedTreeItem) state.selectedTreeItem.classList.remove('selected');
                state.selectedTreeItem = el;
                state.selectedTreeItem.classList.add('selected');
                dom.fileTree.focus();
            };
            
            if (isFolder) {
                element.className = 'folder';
                const header = document.createElement('div');
                header.className = 'folder-header';
                header.dataset.path = item.path;
                header.dataset.type = 'folder';
                header.innerHTML = `<span class="folder-arrow">${CHEVRON_RIGHT_SVG}</span><span class="file-icon-wrapper">${FOLDER_ICON_SVG}</span><span>${item.name}</span>`;
                
                const content = document.createElement('div');
                content.className = 'folder-content';
                element.append(header, content);

                header.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    selectItem(header);
                    if (element.classList.toggle('expanded') && content.children.length === 0) {
                        const subItems = await fs.promises.readdir(item.path, { withFileTypes: true });
                        const sorted = subItems.map(sub => ({ name: sub.name, isDirectory: sub.isDirectory(), path: path.join(item.path, sub.name) })).sort((a, b) => (a.isDirectory === b.isDirectory) ? a.name.localeCompare(b.name) : a.isDirectory ? -1 : 1);
                        sorted.forEach(subItem => content.appendChild(createFileTreeItem(subItem)));
                    }
                });
                return element;
            } else {
                element.className = 'file-item file';
                element.innerHTML = `<span class="file-icon-wrapper">${FILE_ICON_SVG}</span><span>${item.name}</span>`;
                element.addEventListener('click', (e) => { e.stopPropagation(); selectItem(element); });
                element.addEventListener('dblclick', () => openFile(item.path));
                return element;
            }
        }
        
        function initNewItemInExplorer(isFolder = false) {
            if (!state.currentDirPath) { alert("Abra uma pasta primeiro."); return; }
            document.querySelector('.new-item-input-wrapper')?.remove();

            const wrapper = document.createElement('div');
            wrapper.className = 'new-item-input-wrapper';
            const icon = isFolder ? FOLDER_ICON_SVG : FILE_ICON_SVG;
            wrapper.innerHTML = `<span class="file-icon-wrapper">${icon}</span><input type="text" class="new-item-input">`;
            const input = wrapper.querySelector('input');
            dom.fileTree.prepend(wrapper);
            input.focus();

            const createAction = async () => {
                const name = input.value.trim();
                if (name) {
                    const newPath = path.join(state.currentDirPath, name);
                    try {
                        if (isFolder) {
                            await fs.promises.mkdir(newPath);
                        } else {
                            await fs.promises.writeFile(newPath, '');
                        }
                        await loadDirectory(state.currentDirPath, false);
                    } catch (e) { alert(`Erro ao criar ${isFolder ? 'pasta' : 'arquivo'}: ${e.message}`); }
                }
                wrapper.remove();
            };
            input.addEventListener('keydown', (e) => { if (e.key === 'Enter') createAction(); if (e.key === 'Escape') wrapper.remove(); });
            input.addEventListener('blur', createAction);
        }

        async function handleDeleteSelectedItem() {
            if (!state.selectedTreeItem) return;
            const itemPath = state.selectedTreeItem.dataset.path;
            const itemType = state.selectedTreeItem.dataset.type;
            const itemName = path.basename(itemPath);

            const confirmation = confirm(`Tem certeza que deseja apagar ${itemType === 'folder' ? 'a pasta' : 'o arquivo'} "${itemName}"? Esta ação não pode ser desfeita.`);

            if (confirmation) {
                try {
                    await fs.promises.rm(itemPath, { recursive: true, force: true });
                    if (itemPath === state.currentFilePath) {
                        createNewFile();
                    }
                    await loadDirectory(state.currentDirPath, false);
                } catch (e) {
                    alert(`Erro ao apagar: ${e.message}`);
                }
            }
        }

        // --- LÓGICA DO REDIMENSIONADOR ---
        function initResizer() {
            let isResizing = false;
            dom.resizer.addEventListener('mousedown', () => { 
                isResizing = true; 
                dom.resizer.classList.add('resizing'); 
                dom.body.style.cursor = 'col-resize'; 
            });
            document.addEventListener('mousemove', (e) => { 
                if (isResizing) dom.fileExplorer.style.width = `${e.clientX}px`; 
            });
            document.addEventListener('mouseup', () => { 
                if(isResizing) { 
                    isResizing = false; 
                    dom.resizer.classList.remove('resizing'); 
                    dom.body.style.cursor = 'default';
                } 
            });
        }

        // --- LÓGICA DA BUSCA (CTRL+F) ---
        function initSearch() {
            const performSearch = () => {
                const query = dom.searchInput.value;
                if (!query) {
                    dom.highlights.innerHTML = '';
                    dom.searchResults.textContent = '0/0';
                    return;
                }
                const regex = new RegExp(query, 'gi');
                state.search.matches = [...dom.textEditor.value.matchAll(regex)];
                dom.highlights.innerHTML = dom.textEditor.value.replace(regex, (match) => `<span class="highlight">${match}</span>`);
                state.search.currentIndex = -1;
                updateSearchResults();
                if (state.search.matches.length > 0) scrollToMatch(0);
            };
            const updateSearchResults = () => dom.searchResults.textContent = `${state.search.currentIndex + 1}/${state.search.matches.length}`;
            const scrollToMatch = (index) => {
                if(index < 0 || index >= state.search.matches.length) return;
                state.search.currentIndex = index;
                document.querySelectorAll('#highlights .highlight.active').forEach(el => el.classList.remove('active'));
                const allHighlights = document.querySelectorAll('#highlights .highlight');
                if (allHighlights[index]) allHighlights[index].classList.add('active');
                
                const match = state.search.matches[index];
                const textBeforeMatch = dom.textEditor.value.substring(0, match.index);
                const lineCount = textBeforeMatch.split('\n').length;
                const lineHeight = parseFloat(getComputedStyle(dom.textEditor).lineHeight);
                dom.textEditor.scrollTop = (lineCount - 5) * lineHeight;
                updateSearchResults();
            };

            dom.searchInput.addEventListener('input', performSearch);
            document.getElementById('search-next').addEventListener('click', () => scrollToMatch((state.search.currentIndex + 1) % state.search.matches.length));
            document.getElementById('search-prev').addEventListener('click', () => scrollToMatch((state.search.currentIndex - 1 + state.search.matches.length) % state.search.matches.length));
            document.getElementById('search-close').addEventListener('click', () => dom.searchBar.classList.add('hidden'));
        }

        // --- INICIALIZAÇÃO E EVENT LISTENERS ---
        function init() {
            // Atalhos globais
            window.addEventListener('keydown', (e) => {
                if (e.ctrlKey) {
                    if (e.key.toLowerCase() === 's') { e.preventDefault(); handleSave(e.shiftKey); }
                    if (e.key.toLowerCase() === 'n') { e.preventDefault(); createNewFile(); }
                    if (e.key.toLowerCase() === 'f') { e.preventDefault(); dom.searchBar.classList.remove('hidden'); dom.searchInput.focus(); dom.searchInput.select(); }
                }
                if (e.key === 'Escape' && !dom.searchBar.classList.contains('hidden')) { e.preventDefault(); dom.searchBar.classList.add('hidden'); }
            });

            // Eventos do Editor de Texto
            dom.textEditor.addEventListener('input', () => {
                if (!state.isModified) { state.isModified = true; updateTitleBar(); }
                updateLineNumbers();
                if (!dom.searchBar.classList.contains('hidden')) {
                    const query = dom.searchInput.value;
                    if(query) {
                        dom.highlights.innerHTML = dom.textEditor.value.replace(new RegExp(query, 'gi'), (match) => `<span class="highlight">${match}</span>`);
                    } else {
                        dom.highlights.innerHTML = '';
                    }
                }
            });
            dom.textEditor.addEventListener('scroll', syncScroll);
            dom.textEditor.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = dom.textEditor.selectionStart;
                    dom.textEditor.value = dom.textEditor.value.substring(0, start) + '\t' + dom.textEditor.value.substring(dom.textEditor.selectionEnd);
                    dom.textEditor.selectionStart = dom.textEditor.selectionEnd = start + 1;
                }
            });

            // Eventos do Explorador de Arquivos
            document.getElementById('show-explorer').addEventListener('click', () => dom.fileExplorer.classList.toggle('visible'));
            document.getElementById('new-file-explorer').addEventListener('click', () => initNewItemInExplorer(false));
            document.getElementById('new-folder-explorer').addEventListener('click', () => initNewItemInExplorer(true));
            document.getElementById('nav-back').addEventListener('click', () => { if (state.navigationHistory.length > 0) loadDirectory(state.navigationHistory.pop(), false); });
            dom.fileTree.addEventListener('keydown', (e) => { if (e.key === 'Delete') handleDeleteSelectedItem(); });

            // Eventos de Menus
            document.getElementById('file-menu').addEventListener('click', (e) => { e.stopPropagation(); dom.fileSubmenu.classList.toggle('show-submenu'); dom.themeSubmenu.classList.remove('show-submenu'); });
            document.getElementById('theme-menu').addEventListener('click', (e) => { e.stopPropagation(); dom.themeSubmenu.classList.toggle('show-submenu'); dom.fileSubmenu.classList.remove('show-submenu'); });
            document.addEventListener('click', () => { dom.fileSubmenu.classList.remove('show-submenu'); dom.themeSubmenu.classList.remove('show-submenu'); });

            dom.fileSubmenu.addEventListener('click', async (e) => {
                const action = e.target.closest('.submenu-item')?.dataset.action;
                if (!action) return;
                
                if (action === 'new-file') createNewFile();
                if (action === 'open-file') dom.fileInput.click();
                if (action === 'open-folder') {
                    const r = await ipcRenderer.invoke('select-folder'); 
                    if (r && !r.canceled && r.filePaths[0]) loadDirectory(r.filePaths[0]);
                }
                if (action === 'save-file') handleSave(false);
                if (action === 'save-as') handleSave(true);
                
                dom.fileSubmenu.classList.remove('show-submenu');
            });
            dom.themeSubmenu.addEventListener('click', (e) => { const theme = e.target.closest('.submenu-item')?.dataset.theme; if (theme) dom.body.className = `theme-${theme}`; dom.themeSubmenu.classList.remove('show-submenu'); });
            
            // Eventos de Sistema e IPC
            document.getElementById('terminal-toggle').addEventListener('click', () => ipcRenderer.send('open-standalone-terminal', state.currentDirPath));
            document.getElementById('tools-menu').addEventListener('click', () => ipcRenderer.send('open-tools-window'));
            dom.fileInput.addEventListener('change', (e) => { if (e.target.files[0]) openFile(e.target.files[0].path); e.target.value = ''; });
            document.getElementById('close-btn').addEventListener('click', () => ipcRenderer.send('close-window'));
            document.getElementById('minimize-btn').addEventListener('click', () => ipcRenderer.send('minimize-window'));
            document.getElementById('maximize-btn').addEventListener('click', () => ipcRenderer.send('toggle-maximize'));

            ipcRenderer.on('window-state-change', (_, isMaximized) => {
                const maxBtnIcon = document.querySelector('#maximize-btn svg');
                maxBtnIcon.innerHTML = isMaximized ? `<polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line>` : `<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>`;
            });

            // Inicialização dos módulos
            initResizer();
            initSearch();
            toggleWelcomePage(true);
            updateLineNumbers();
        }

        // Inicia a aplicação
        init();
    </script>
</body>
</html>